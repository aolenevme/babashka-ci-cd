#!/usr/bin/env node
const childProcessExec = require("child_process").exec;
const util = require("util");

const exec = util.promisify(childProcessExec);

async function validateBranchName() {
    const localBranch = await exec("git rev-parse --abbrev-ref HEAD");
    const validBranchRegex = new RegExp("^(master|develop|(feat|release|hotfix)\/[a-z0-9._-]+)$", "u");
    const message = `Branch names in this project must adhere to this contract: ${validBranchRegex}.`;

    if (validBranchRegex.test(localBranch.stdout.trim())) {
        console.log("\n");
    } else {
        console.log(message);
        process.exit(1);
    }
}

async function formatClojureScript() {
    try {
        const res = await exec("zprint-clj -i ./src/**/*.cljs -o ./");

        console.log(res.stdout);
    } catch {
        console.error("Failed to format the ClojureScript code");
        process.exit(1);
    }
}

async function lintJavaScript() {
    try {
        const res = await exec("yarn lint:js");

        console.log(res.stdout);
    } catch {
        console.error("Failed to lint the JavaScript code");
        process.exit(1);
    }
}

(async () => {
    await validateBranchName();
    await formatClojureScript();
    await lintJavaScript();
})();
